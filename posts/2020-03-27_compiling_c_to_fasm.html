<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>0rw96vl5hka8zksah98x3khm19fbblxd-2020-03-27_compiling_c_to_fasm</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h2 id="compiling-c-to-fasm">Compiling C to FASM</h2>
<p>It is well-known that programs written in assembler are much smaller than programs of same functionality written in high-level language, such as C. Convenience and portability has their price.</p>
<p>I want to talk about way to sacrifice portability (x86 &amp; x86_64 only) to drastically reduce code size. Given that today most computers of that architecture are overpowered – at least 512Mb of RAM and many gigabytes of disk storage – this is not going to be life-changer, yet I am surprised that I have never saw it before.</p>
<p>Let us talk about this simple program that exits with code specified on command line:</p>
<pre><code>#include &lt;inttypes.h&gt;

int64_t s2uint(const unsigned char *s)
{
    uint64_t res = 0;
    unsigned char c;


    for (; c = *s; s++) {
        c -= &#39;0&#39;;
        if (c &gt; 9) {
            return -1;
        }
        res = 10 * res + c;
    }

    return res;
}

int main(int argc, char **argv)
{
    if (argc != 2)
        return -1;
    return s2uint(argv[1]);
}</code></pre>
<p>Even compiled with size optimization, linked with musl<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> C library instead of glibc<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and stripped, resulting binary is around 13Kb. Sure, you can’t just dump raw instruction opcodes into file and call it a day, ELF format has its overhead, but 13Kb overhead for barely 100 bytes of code?!</p>
<p>What we are going to do to is ask compiler to just output assembler code for these functions. Compilers are good at compiling, but we’d rather do linking ourself. We will use fasm<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> assembler for that.</p>
<p>Unfortunately, syntax of assembler file generated by neither GCC nor clang is fully compatible with fasm, so some minor automatic post-processing is required. After that we need to write a tiny bit of assembler code.</p>
<pre><code>include &quot;out/cc/s2uint.fasm&quot;
include &quot;out/cc/exit.fasm&quot;

entry $
    mov rdi, [rsp]
    lea rsi, [rsp + 8]
    call main
    mov edi, eax
    mov eax, sys_exit
    syscall</code></pre>
<p>It forwards command line arguments to main function and after it returns, invokes “exit” system call with appropriate argument. Our result is 201 byte. We managed reduce program size by factor 26.</p>
<p>Of course, it all went smoothly because our program did not use any functions from standard library. Otherwise we would have to untangle them from sources of standard library, and they never were intended for that. I am yet to discover how much work it will be to compile some real application, like text browser or git this way.</p>
<p>What I described is crude hack. It is shame that after decades of theoretical research and practical engineering of optimizing compilers, none of them is capable to generate binary of size even remotely close to optimal. See elaborate comparison here<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://musl.libc.org/" class="uri">https://musl.libc.org/</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p><a href="https://www.gnu.org/software/libc/" class="uri">https://www.gnu.org/software/libc/</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p><a href="https://flatassembler.net" class="uri">https://flatassembler.net</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p><a href="https://drewdevault.com/2020/01/04/Slow.html" class="uri">https://drewdevault.com/2020/01/04/Slow.html</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
